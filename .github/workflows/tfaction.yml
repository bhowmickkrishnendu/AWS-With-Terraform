name: CI/CD Terraform Pipeline
on:
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      action:
        description: "Action to take (apply/destroy)"
        required: true
        default: "apply"
        type: choice
        options:
          - apply
          - destroy

env:
  AWS_REGION: ap-south-1

jobs:
  init:
    uses: bhowmickkrishnendu/terraform-gha-workflows/.github/workflows/init.yml@v1.0.22
    with:
      working-directory: v2_2025/AWS-Main/IAM_Role_Policy_Root
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  validate:
    needs: init
    uses: bhowmickkrishnendu/terraform-gha-workflows/.github/workflows/validate.yml@v1.0.22
    with:
      working-directory: v2_2025/AWS-Main/IAM_Role_Policy_Root
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  plan:
    needs: validate
    uses: bhowmickkrishnendu/terraform-gha-workflows/.github/workflows/plan.yml@v1.0.22
    with:
      working-directory: v2_2025/AWS-Main/IAM_Role_Policy_Root
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Manual review gate for both PR and workflow_dispatch
  plan-review:
    needs: plan
    runs-on: ubuntu-latest
    environment:
      name: plan-review
      url: https://krishnendu.online
    steps:
      - name: Plan Review Gate
        run: |
          echo "üîç TERRAFORM PLAN REVIEW REQUIRED"
          echo "================================================"
          echo "Please review the plan output for:"
          echo "‚úÖ No unexpected resource deletions (destroy)"
          echo "‚úÖ No unwanted resource recreations (replace)"
          echo "‚úÖ IAM policy changes are safe"
          echo "‚úÖ Security group modifications reviewed"
          echo "‚úÖ Network/VPC changes validated"
          echo "‚úÖ Database/storage changes are safe"
          echo "‚úÖ Resource naming changes won't cause issues"
          echo "================================================"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "================================================"
          echo "Manual approval required before proceeding..."

  # Apply job - runs after plan review approval
  apply:
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
      (github.event_name == 'pull_request')
    needs: plan-review
    uses: bhowmickkrishnendu/terraform-gha-workflows/.github/workflows/apply.yml@v1.0.22
    with:
      working-directory: v2_2025/AWS-Main/IAM_Role_Policy_Root
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # Destroy job - only for manual workflow_dispatch
  destroy:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    needs: plan-review
    uses: bhowmickkrishnendu/terraform-gha-workflows/.github/workflows/destroy.yml@v1.0.22
    with:
      working-directory: v2_2025/AWS-Main/IAM_Role_Policy_Root
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}